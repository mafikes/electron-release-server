services:
  web:
    build: .
    environment:
      WEBSITE_TITLE: ${WEBSITE_TITLE:-Electron Release Server}
      WEBSITE_HOME_CONTENT: ${WEBSITE_HOME_CONTENT:-}
      WEBSITE_NAV_LOGO: ${WEBSITE_NAV_LOGO:-}
      WEBSITE_APP_TITLE: ${WEBSITE_APP_TITLE:-Electron Release Server}
      APP_USERNAME: ${APP_USERNAME:-admin}
      APP_PASSWORD: ${APP_PASSWORD:-changeme}
      DB_HOST: db
      DB_PORT: 5432
      DB_USERNAME: ${DB_USERNAME:-releaseserver}
      DB_NAME: ${DB_NAME:-releaseserver}
      DB_PASSWORD: ${DB_PASSWORD:-secret}
      DATA_ENCRYPTION_KEY: ${DATA_ENCRYPTION_KEY:-oIh0YgyxQbShuMjw4/laYcZnGKzvC3UniWFsqL0t4Zs=}
      TOKEN_SECRET: ${TOKEN_SECRET:-change_me_in_production}
      APP_URL: ${APP_URL:-localhost}
      ASSETS_PATH: /usr/src/electron-release-server/releases
    depends_on:
      db:
        condition: service_healthy
    expose:
      - "80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    volumes:
      - releases:/usr/src/electron-release-server/releases

  db:
    image: postgres:11
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD:-secret}
      POSTGRES_USER: ${DB_USERNAME:-releaseserver}
      POSTGRES_DB: ${DB_NAME:-releaseserver}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-releaseserver} -d ${DB_NAME:-releaseserver}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    volumes:
      - postgres:/var/lib/postgresql/data

volumes:
  postgres:
  releases:
